<!DOCTYPE html>
<html>

<head>
    <title>Bug to changeset mapper</title>
    <style>
        #grid-container {
            margin-left: 20px;
            margin-right: 20px;
        }

        .config-section {
            margin: 10px;
        }
    </style>
    <script src="sdk/scripts/VSS.SDK.min.js"></script>
    <script type="text/javascript">
        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformScripts: true,
            usePlatformStyles: true
        });

        VSS.require(["VSS/Service", "TFS/WorkItemTracking/RestClient", "VSS/Controls", "VSS/Controls/TreeView", "VSS/Controls/Grids"],
        function (VSS_Service, TFS_Wit_WebApi, Controls, TreeView, Grids) {
            // Get the REST client
            var witClient = VSS_Service.getCollectionClient(TFS_Wit_WebApi.WorkItemTrackingHttpClient);
            var projectId = VSS.getWebContext().project.id;
            var dataSource = [];
            var changesetPattern = new RegExp("vstfs:///VersionControl/Changeset/([0-9]*)", "i");


            // Converts the source to TreeNodes
            function convertToTreeNodes(items) {
                return $.map(items, function (item) {
                    var node = new TreeView.TreeNode(item.name);
                    node.icon = item.icon;
                    node.expanded = item.expanded;
                    if (item.children && item.children.length > 0) {
                        node.addRange(convertToTreeNodes(item.children));
                    }
                    return node;
                });
            }

            witClient.getQueries(projectId, "All", 2, false).then(
                function (queries) {

                    var treeViewOptions = {
                        width: 400,
                        height: "100%",
                        nodes: convertToTreeNodes(queries)
                    };
                    // Create the treeView in a container element
                    var treeview = Controls.create(TreeView.TreeView, $("#treeview-container"), treeViewOptions);

                },
                function (reject) {
                    console.log(reject);
                    console.log("reject.status" + reject.status);
                    console.log("reject.message" + reject.message);
                });

            var container = $("#treeview-container");

            // Attach selectionchanged event using a DOM element containing treeview
            container.bind("selectionchanged", function (e, args) {
                var selectedNode = args.selectedNode;
                if (selectedNode) {
                    alert('${selectedNode.text} selected!');
                }
            });

            var gridOptions = {
                height: "100%",
                width: "100%",
                source: dataSource,
                columns: [
                    // text is the column header text.
                    // index is the key into the source object to find the data for this column
                    // width is the width of the column, in pixels
                    { text: "S.No", index: "sno", width: 50 },
                    { text: "ID", index: "key", width: 100 },
                    { text: "Title", index: "title", width: 300 },
                    { text: "Severity", index: "severity", width: 100 },
                    { text: "Created By", index: "createdBy", width: 200 },
                    { text: "Area Path", index: "areaPath", width: 300 },
                    { text: "Changeset", index: "changeset", width: 200 }
                ]
            };

            var grid = Controls.create(Grids.Grid, $("#grid-container"), gridOptions);

            $("#refreshResult").click(function () {
                // getWorkItems(ids, fields, asOf, expand)
                var commaSeparatedBugIds = $("#bugIds").val();
                witClient.getWorkItems([commaSeparatedBugIds], undefined, undefined, "All").then(
                    function (workitems) {
                        dataSource = [];
                        workitems.forEach(function (workitem, index) {
                            var changesetNumber = "";

                            for (var j = 0; workitem.relations && j < workitem.relations.length; j++) {
                                var relation = workitem.relations[j];
                                if (!relation.url) continue;
                                var changesetMatches = changesetPattern.exec(relation.url);
                                if (changesetMatches && changesetMatches.length > 1) {
                                    changesetNumber = (changesetNumber == "" ? "" : (changesetNumber + ", ")) + changesetMatches[1];
                                }
                            }
                            dataSource.push({
                                sno: index + 1,
                                key: workitem.id,
                                title: workitem.fields["System.Title"],
                                severity: workitem.fields["Microsoft.VSTS.Common.Severity"],
                                createdBy: workitem.fields["System.CreatedBy"],
                                areaPath: workitem.fields["System.AreaPath"],
                                changeset: changesetNumber
                            })
                        });
                        grid.setDataSource(dataSource);
                    }, function (reject) {
                        console.log(reject);
                        console.log("reject.status" + reject.status);
                        console.log("reject.message" + reject.message);
                    });
            });
            VSS.notifyLoadSucceeded();
        });
    </script>
</head>

<body>
    <div class="hub-view explorer work-items-view new-work-items-view triage-view">
        <div class="hub-content">
            <div class="hub-splitter splitter horizontal right">
                <div class="leftPane">
                    <section class="config-section">
                        <fieldset>
                            <div>Bug IDs (comma separated)</div> <br />
                            <textarea rows="4" cols="30" id="bugIds" name="bugIds"></textarea>
                            <br />
                            <button id="refreshResult" name="refreshResult" title="Refresh Result">Refresh Result</button>
                        </fieldset>
                        <div id="treeview-container"></div>
                    </section>
                </div>
                <div class="handleBar">
                </div>
                <div class="rightPane">
                    <div class="hub-title">Bugs with changeset</div>
                    <div id="grid-container" class="right-hub-content"></div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>