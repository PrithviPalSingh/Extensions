<!DOCTYPE html>
<html>
<head>
    <title>Bug to changeset mapper</title>
    <style>
        #grid-container {
            margin-left: 20px;
            margin-right: 20px;
            margin-top: 10px;
        }

        .config-section {
            margin: 10px;
        }

        .error {
            background-color: #ffc;
            border: 1px solid #e6e6e6;
        }

        .bottom-separator {
            padding-bottom: 10px;
            border-bottom: 1px solid #ccc;
        }
    </style>
    <script src="sdk/scripts/VSS.SDK.min.js"></script>
    <script src="sdk/scripts/app.js" type="text/javascript"></script>
    <script type="text/javascript" src="sdk/scripts/export.js"></script>
</head>
<body>
    <div class="hub-view explorer work-items-view new-work-items-view triage-view">
        <div class="hub-content">
            <div class="hub-splitter splitter horizontal right">
                <div class="leftPane">
                    <section class="config-section">
                        <fieldset class="bottom-separator">
                            <div>Bug IDs (comma separated)</div> <br />
                            <textarea rows="4" cols="30" id="bugIds" name="bugIds"></textarea>
                            <br />
                            <button id="refreshResult" name="refreshResult" title="Refresh Result">Refresh Result</button>
                        </fieldset>
                        <div id="treeview-container"></div>
                    </section>
                </div>
                <div class="handleBar">
                </div>
                <div class="rightPane">
                    <div class="hub-title">
                        <div class="query-result-grid-info">
                            <div id="status-indicator" class="status-indicator inline" style="display: none;">
                                <div class="status status-inline" aria-busy="true"></div>
                                <span class="status-progress"></span>
                            </div>
                            <span id="page-title">Bugs with changeset</span>
                            <span class="error" id="error" style="display:none;"></span>
                            <div class="hub-progress pageProgressIndicator" id="progressIndicator" style="visibility: hidden;"></div>
                        </div><div>
                            <a download="export.xls"
                               href="#"
                               onclick="return ExportToExcel();">
                                Export table to Excel
                            </a>
                        </div>
                    </div>
                    <div id="grid-container" class="right-hub-content"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="container" style="display:none">
    </div>
</body>

<script>
    function ExportToExcel() {
        inner = document.getElementById('grid-container');
        var xml1 = document.createElement('div');
        xml1.innerHTML = inner.innerHTML;
        parser = new DOMParser();
        xmlString = (new XMLSerializer()).serializeToString(inner);
        xmlString = xmlString.replace('xmlns="http://www.w3.org/1999/xhtml"', '');
        xml = parser.parseFromString(xmlString, "text/xml");

        xsl = loadXMLDoc("Excel.xslt");
        if (window.ActiveXObject || "ActiveXObject" in window) {
            //var xslt = new ActiveXObject("Msxml2.XSLTemplate");

            //ex = xml.transformNode(xsl);
            //document.getElementById("container").innerHTML = ex;
            var xslt = new ActiveXObject("Msxml2.XSLTemplate");
            var xslDoc = new ActiveXObject("Msxml2.FreeThreadedDOMDocument");

            xslDoc.load(xsl);

            //console.log(xslt.styleSheet);
            xslt.stylesheet = xslDoc;
            var xslProc = xslt.createProcessor();
            xslProc.input = xml;
            xslProc.transform();
            document.getElementById("container").innerHTML = xslProc.output;
        }
            // code for Chrome, Firefox, Opera, etc.
        else if (document.implementation && document.implementation.createDocument) {
            xsltProcessor = new XSLTProcessor();
            xsltProcessor.importStylesheet(xsl);
            resultDocument = xsltProcessor.transformToFragment(xml, document);
            document.getElementById('container').appendChild(resultDocument);
        }
        return ExcellentExport.excel(this, 'testTable', 'Sheet Name Here');
    }
    function loadXMLDoc(filename) {
        if (window.ActiveXObject) {
            xhttp = new ActiveXObject("Msxml2.XMLHTTP");
        } else {
            xhttp = new XMLHttpRequest();
        }
        xhttp.open("GET", filename, false);
        xhttp.send("");
        return xhttp.responseXML;
    }
</script>
</html>
